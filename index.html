<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drita, Teleskopët dhe Hëna Jonë e Mrekullueshme!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.132.2/build/three.module.js",
            "three/examples/": "https://unpkg.com/three@0.132.2/examples/"
        }
    }
    </script>
    <script type="module">
        console.log('Starting module initialization...');
        
        import * as THREE from 'three';
        console.log('THREE imported:', THREE);
        
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
        console.log('OrbitControls imported');
        
        import { CSS2DRenderer, CSS2DObject } from 'three/examples/jsm/renderers/CSS2DRenderer.js';
        console.log('CSS2DRenderer imported');
        
        import { SolarSystem, NightSky } from './js/modules/interactive.js';
        console.log('SolarSystem and NightSky imported');
        
        window.THREE = THREE;
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing 3D scenes...');
            try {
                console.log('Creating Solar System...');
                const solarSystem = new SolarSystem('solar-system-container');
                console.log('Solar System created');
                
                console.log('Creating Night Sky...');
                const nightSky = new NightSky('night-sky-container');
                console.log('Night Sky created');
            } catch (error) {
                console.error('Error initializing 3D scenes:', error);
            }
        });
    </script>
    <!-- Chosen Palette: Cosmic Neutrals (Dark space blue/purple, bright yellow, orange, and light blue accents) -->
    <!-- Application Structure Plan: A single-page, vertical storytelling format. Users scroll through 'chapters' about light, telescopes, the moon, and Apollo 11. A sticky icon-based side-nav allows jumping between sections. This structure is more exploratory and engaging for children than a linear slide-by-slide presentation, turning learning into a guided discovery. Added a final auto-scrolling horizontal image carousel with hover controls. YouTube video now autoplays on scroll with controls hidden and scrolls to moon map on completion. Added a final quiz section with viewport-aware timer for each question, start button, and delayed timer appearance. -->
    <!-- Visualization & Content Choices: Replaced static presentation ideas with interactive HTML/CSS diagrams. Telescope: Canvas 2D animation showing light path through two lenses, with parallel, converging, and diverging rays meeting at a focal point, with labels. Animation resets to initial state after completion for replay. Moon Phases: Interactive diagram with a button to cycle through phases, updating a Unicode emoji display. Apollo 11: A 'click to zoom' interaction on a moon map that fades to a detail image, changes caption, then scrolls to a detail section. YouTube video uses Iframe API and Intersection Observer for autoplay with hidden controls and auto-scroll to moon map on end. Image Carousel: JS for horizontal continuous auto-scrolling slides with hover pause and manual navigation. Quiz: Timed questions (20s with 1.5s delay) and answers, timer starts/pauses based on section visibility and restarts for each question. "AI" Features: Now use pre-defined local content for stories and Q&A, with specific and generic moon answers. These choices prioritize direct manipulation and visual feedback over passive viewing. All visuals are built with HTML/CSS/Unicode, no Chart.js needed for this specific design. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Marker Felt', sans-serif;
            background-color: #1a202c; /* Tailwind gray-900 */
            color: #f7fafc; /* Tailwind gray-100 */
            line-height: 1.6;
            overflow-x: hidden; 
        }
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #0c1221; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 1;
            transition: opacity 1s ease-out, transform 1s ease-out;
        }
        #splash-screen.hidden {
            opacity: 0;
            transform: translateY(-100%); 
            pointer-events: none;
        }
        #splash-image {
            max-width: 80%;
            max-height: 60vh;
            border-radius: 50%; 
            box-shadow: 0 0 30px #f6e05e, 0 0 60px #f6e05e; 
            margin-bottom: 2rem;
            border: 4px solid #f6e05e;
        }
        #main-content {
            opacity: 0;
            transition: opacity 0.5s ease-in 0.5s; 
        }
        #main-content.visible {
            opacity: 1;
        }

        .section {
            min-height: 100vh;
            padding: 2rem 1rem sm:p-8 md:p-16; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border-bottom: 2px dashed #4a5568; 
        }
        .section:last-child {
            border-bottom: none;
        }
        .fun-title {
            font-size: 2.25rem; 
            line-height: 2.5rem;
            font-weight: bold;
            color: #f6e05e; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        @media (min-width: 768px) { 
            .fun-title {
                font-size: 3.75rem; 
                line-height: 1;
            }
        }
        .fun-button {
            background-color: #ed8936; 
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 1rem; 
        }
        @media (min-width: 768px) {
            .fun-button {
                font-size: 1.125rem; 
                padding: 1rem 2rem;
            }
        }
        .fun-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.3);
        }
        .fun-button.gemini-btn { 
            background-color: #7c3aed; 
        }
        .fun-button.gemini-btn:hover {
            background-color: #6d28d9; 
        }
        .icon-nav {
            position: fixed;
            top: 50%;
            left: 0.5rem; 
            transform: translateY(-50%);
            display: none; 
            flex-direction: column;
            gap: 0.75rem; 
            background-color: rgba(45, 55, 72, 0.8); 
            padding: 0.75rem;
            border-radius: 1.5rem;
            z-index: 50;
            transition: opacity 0.5s ease-in-out;
        }
         @media (min-width: 768px) { 
            .icon-nav {
                left: 1rem;
                gap: 1rem;
                padding: 1rem;
            }
        }
        .icon-nav.visible {
            display: flex;
        }
        .icon-nav a {
            font-size: 1.5rem; 
            transition: transform 0.2s;
        }
         @media (min-width: 768px) {
            .icon-nav a {
                font-size: 2rem;
            }
        }
        .icon-nav a:hover {
            transform: scale(1.2);
        }
        .light-source-card {
            border: 4px solid #4a5568;
            transition: all 0.3s;
        }
        .light-source-card.active {
            border-color: #f6e05e;
            transform: scale(1.05);
            box-shadow: 0 0 20px #f6e05e;
        }
        
        #telescope-canvas-container {
            width: 100%;
            max-width: 600px; 
            height: 300px; 
            background-color: #0a0f1a; 
            border-radius: 1rem;
            margin-bottom: 1rem;
            position: relative; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
         @media (min-width: 768px) {
            #telescope-canvas-container {
                max-width: 700px;
                height: 350px;
            }
        }
        #telescopeCanvas { 
            display: block; 
            width: 100%;
            height: 100%;
            border-radius: 1rem; 
        }
         .telescope-label { 
            position: absolute;
            color: #e2e8f0; 
            font-size: 0.7rem; 
            font-weight: 500;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.7);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            white-space: nowrap;
            transform: translateX(-50%); 
            padding: 2px 4px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .pulse-marker {
            animation: pulse 2s infinite;
            transition: opacity 0.5s ease-out;
        }
        .video-container {
            width: 100%;
            max-width: 560px; 
            margin: 1.5rem auto; 
            aspect-ratio: 16 / 9;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        #moon-map-container {
            overflow: hidden; 
            width: 90vw; 
            max-width: 400px; 
            aspect-ratio: 1 / 1; 
            position: relative; 
        }
         @media (min-width: 768px) {
            #moon-map-container {
                 max-width: 500px;
            }
        }
        #moon-map-image {
            transition: opacity 0.6s ease-out; 
            transform-origin: 55% 40%; 
            position: relative; 
            z-index: 1; 
        }
        
        #sea-of-tranquility-detail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%; 
            opacity: 0;
            transition: opacity 0.8s ease-in-out, transform 1.5s ease-in-out;
            transform-origin: 55% 40%; 
            transform: scale(1); 
            pointer-events: none; 
            z-index: 2; 
        }
        #sea-of-tranquility-detail.visible-zoomed {
            opacity: 1;
            transform: scale(3); 
            pointer-events: auto; 
        }
        #tranquility-marker-container { 
            position: absolute;
            z-index: 3; 
            cursor: pointer;
        }
        .image-caption {
            margin-top: 0.75rem; 
            font-size: 1rem; 
            color: #cbd5e0; 
            font-weight: 600; 
        }
         @media (min-width: 768px) {
            .image-caption {
                font-size: 1.125rem;
            }
        }
        .carousel-container {
            width: 100%;
            max-width: 90vw; 
            margin: 2rem auto;
            position: relative;
            overflow: hidden;
            padding: 1rem 0; 
        }
        .carousel-track {
            display: flex;
        }
        .carousel-slide {
            flex: 0 0 85vw; 
            width: 85vw;   
            max-width: 320px; 
            margin-right: 1rem; 
            box-sizing: border-box;
        }
        .carousel-slide img {
            width: 100%;
            height: auto;
            aspect-ratio: 16 / 10; 
            object-fit: cover;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: block;
        }

        @media (min-width: 640px) { 
            .carousel-slide {
                flex: 0 0 380px; 
                width: 380px;
                max-width: none; 
            }
        }

        @media (min-width: 1024px) { 
            .carousel-slide {
                flex: 0 0 450px; 
                width: 450px;
            }
        }
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(237, 137, 54, 0.9); 
            color: white;
            border: none;
            padding: 0.5rem; 
            width: 2.5rem; 
            height: 2.5rem; 
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            opacity: 0; 
            transition: opacity 0.3s ease-in-out;
        }
        .carousel-container:hover .carousel-button {
            opacity: 1; 
        }
        .carousel-button.prev {
            left: 5px; 
        }
        .carousel-button.next {
            right: 5px; 
        }
         @media (min-width: 768px) {
            .carousel-button.prev {
                left: -10px; 
            }
            .carousel-button.next {
                right: -10px; 
            }
        }
        .ai-output { 
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: rgba(45, 55, 72, 0.5); 
            border-radius: 0.75rem;
            max-width: 90%;
            sm:max-width: 80%;
            md:max-width: 70%;
            lg:max-w-3xl;
            text-align: left;
            min-height: 100px;
            border: 1px solid #4a5568;
            margin-left: auto; 
            margin-right: auto;
        }
        .ai-input { 
            width: 100%;
            max-width: 500px;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #4a5568;
            background-color: #2d3748; 
            color: #f7fafc;
            margin-bottom: 1rem;
        }
        /* Quiz Section Styles */
        #quiz-question {
            font-size: 1.25rem; /* Tailwind text-xl */
            color: #facc15; /* Tailwind yellow-500 */
            margin-bottom: 1.5rem;
            min-height: 3em; /* Ensure space for question */
        }
        #quiz-answer {
            font-size: 1.125rem; /* Tailwind text-lg */
            color: #93c5fd; /* Tailwind blue-300 */
            background-color: rgba(45, 55, 72, 0.3);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            min-height: 2.5em; /* Ensure space for answer */
        }
        #quiz-active-area.hidden, #start-quiz-btn.hidden {
            display: none;
        }
        
        #solar-system-container, #night-sky-container {
            position: relative;
            overflow: hidden;
            touch-action: none;
        }
        
        .planet-label, .constellation-label {
            pointer-events: none;
            white-space: nowrap;
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="splash-screen">
        <img id="splash-image" src="images/noari_limani_astronaut.jpg" alt="Noar si Astronaut" 
             onerror="this.onerror=null; this.src='https://placehold.co/400x400/0c1221/f6e05e?text=Noar+Astronaut'; this.style.border='2px solid #f6e05e'; this.style.borderRadius='50%'; this.style.backgroundColor='#0c1221';" />
        <button id="splash-continue-btn" class="fun-button text-xl mt-8">Fillo Aventurën!</button>
    </div>

    <nav id="main-nav" class="icon-nav">
        <a href="#intro" title="Hyrja">🌟</a>
        <a href="#light" title="Drita">💡</a>
        <a href="#telescope" title="Teleskopi">🔭</a>
        <a href="#moon" title="Hëna">🌙</a>
        <a href="#apollo" title="Apollo 11">🚀</a>
        <a href="#noar-adventures" title="Aventurat e Noarit">🖼️</a>
        <a href="#quiz-section" title="Kuizi">❓</a>
    </nav>

    <main id="main-content">
        <section id="intro" class="section bg-gray-900">
            <h1 class="fun-title mb-4">Drita, Teleskopët,</h1>
            <h1 class="fun-title mb-8">dhe Hëna Jonë e Mrekullueshme!</h1>
            <p class="text-xl sm:text-2xl text-gray-300 mb-4">Një projekt shkollor nga një astronaut i ardhshëm!</p>
            <p class="text-lg sm:text-xl text-gray-400 mb-6">Noar Limani II-4</p>
            <a href="#light" class="fun-button text-lg sm:text-xl">Fillo Eksplorimin! 👇</a>
        </section>

        <section id="light" class="section">
            <h2 class="fun-title mb-4">Çfarë është Drita?</h2>
            <p class="max-w-xl sm:max-w-2xl text-lg sm:text-xl md:text-2xl text-gray-300 mb-8">Drita na ndihmon të shohim gjithçka! Ajo vjen nga gjërat e ndritshme dhe udhëton super shpejt. Kliko mbi figura për të mësuar më shumë!</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-8 w-full max-w-md sm:max-w-2xl md:max-w-4xl">
                <div class="light-source-card bg-gray-800 p-4 sm:p-6 rounded-2xl cursor-pointer" onclick="toggleLightSource(this, 'sun')">
                    <div class="text-5xl sm:text-6xl mb-4">☀️</div>
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-300">Dielli</h3>
                </div>
                <div class="light-source-card bg-gray-800 p-4 sm:p-6 rounded-2xl cursor-pointer" onclick="toggleLightSource(this, 'lamp')">
                    <div class="text-5xl sm:text-6xl mb-4">💡</div>
                    <h3 class="text-xl sm:text-2xl font-bold text-blue-300">Një Llampë</h3>
                </div>
                 <div class="light-source-card bg-gray-800 p-4 sm:p-6 rounded-2xl cursor-pointer" onclick="toggleLightSource(this, 'firefly')">
                    <div class="text-5xl sm:text-6xl mb-4">🦟</div>
                    <h3 class="text-xl sm:text-2xl font-bold text-green-300">Një Xixëllonjë</h3>
                </div>
                 <div class="light-source-card bg-gray-800 p-4 sm:p-6 rounded-2xl cursor-pointer" onclick="toggleLightSource(this, 'flashlight')">
                    <div class="text-5xl sm:text-6xl mb-4">🔦</div>
                    <h3 class="text-xl sm:text-2xl font-bold text-purple-300">Një Elektrik Dore</h3>
                </div>
            </div>
            <div id="light-fact" class="mt-8 text-xl sm:text-2xl h-12 text-orange-400 font-bold"></div>
            <button id="generate-light-story-btn" class="fun-button gemini-btn mt-8">✨ Krijo një Tregim për Dritën!</button>
            <div id="light-story-output" class="ai-output hidden"></div>
        </section>

        <section id="telescope" class="section">
            <h2 class="fun-title mb-4">Sy Super të Fuqishëm!</h2>
            <p class="max-w-xl sm:max-w-2xl text-lg sm:text-xl md:text-2xl text-gray-300 mb-8">Teleskopët përdorin THJERRËZA për të përthyer dritën dhe për t'i bërë gjërat e largëta të duken më të mëdha. Shtyp butonin për të parë se si!</p>
            <div id="telescope-canvas-container">
                <canvas id="telescopeCanvas"></canvas>
                <div id="label-canvas-source-moon" class="telescope-label">Hëna</div>
                <div id="label-canvas-objective-lens" class="telescope-label">Thjerrëza Objektive</div>
                <div id="label-canvas-focal-point" class="telescope-label">Pika Fokale</div>
                <div id="label-canvas-eyepiece-lens" class="telescope-label">Okulari</div>
                <div id="label-canvas-magnified-moon" class="telescope-label">Hëna e Zmadhuar</div>
            </div>
            <button id="telescope-canvas-btn" class="fun-button mt-4">Shiko si funksionon!</button>
        </section>

        <section id="moon" class="section">
            <h2 class="fun-title mb-4">Hëna Jonë Misterioze</h2>
            <p class="max-w-xl sm:max-w-2xl text-lg sm:text-xl md:text-2xl text-gray-300 mb-8">A e ke vënë re që Hëna ndryshon formë? Këto quhen Faza! Nuk është magji, thjesht varet se si Dielli e ndriçon atë.</p>
            <div class="flex flex-col md:flex-row items-center justify-center gap-8 w-full max-w-lg md:max-w-3xl lg:max-w-5xl">
                <div class="relative w-48 h-48 sm:w-64 sm:h-64 md:w-80 md:h-80">
                    <div class="absolute inset-0 border-2 border-dashed border-gray-600 rounded-full"></div>
                    <div id="moon-earth" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-6xl sm:text-7xl md:text-8xl">🌍</div>
                    <div id="moon-orbit" class="absolute inset-0 transition-transform duration-1000">
                        <div id="moon-object" class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 text-4xl sm:text-5xl md:text-6xl">🌓</div>
                    </div>
                    <div class="absolute -right-16 sm:-right-20 md:-right-32 top-1/2 -translate-y-1/2 text-6xl sm:text-7xl md:text-8xl">☀️</div>
                </div>
                <div class="text-center mt-8 md:mt-0">
                    <h3 class="text-2xl sm:text-3xl font-bold text-yellow-300 mb-4">Çfarë shohim nga Toka:</h3>
                    <div id="moon-phase-display" class="text-7xl sm:text-8xl md:text-9xl mb-4">🌓</div>
                    <p id="moon-phase-name" class="text-xl sm:text-2xl text-gray-300 font-bold mb-6">Çereku i Parë</p>
                    <button id="phase-btn" class="fun-button">Faza Tjetër</button>
                </div>
            </div>
            <div class="mt-10 w-full max-w-xl">
                <input type="text" id="moon-question-input" class="ai-input" placeholder="Shtyp pyetjen tënde për Hënën këtu...">
                <button id="ask-moon-btn" class="fun-button gemini-btn">✨ Pyet Hënën Diçka!</button>
                <div id="moon-answer-output" class="ai-output hidden mt-4"></div>
            </div>
        </section>

        <section id="apollo" class="section">
            <h2 class="fun-title mb-4">Një Hap Gjigant!</h2>
            <p class="max-w-xl sm:max-w-2xl md:max-w-3xl text-lg sm:text-xl md:text-2xl text-gray-300 mb-8">A e dije që njerëzit kanë ECUR në Hënë? Misioni Apollo 11 ishte hera e parë që njerëzit vizituan një botë tjetër.</p>
            
            <div id="video-player-container" class="video-container">
                <div id="apollo-video-player"></div>
            </div>
            
            <p class="max-w-xl sm:max-w-2xl md:max-w-3xl text-lg sm:text-xl md:text-2xl text-gray-300 mt-8 mb-8">Kliko shenjën në hartën e Hënës më poshtë për të parë ku u ulën!</p>

            <div class="w-full max-w-xs sm:max-w-sm md:max-w-lg text-center">
                <div id="moon-map-container" class="aspect-square rounded-full bg-gray-700 relative cursor-pointer mx-auto">
                     <img id="moon-map-image" src="https://images.pexels.com/photos/47367/full-moon-moon-bright-sky-47367.jpeg"
                          class="w-full h-full rounded-full object-cover"
                          onerror="this.onerror=null; this.src='https://placehold.co/800x800/cccccc/ffffff?text=Harta+Alternative';"
                          alt="Harta e Hënës që tregon zonën e uljes së Apollo 11"/>
                     <img id="sea-of-tranquility-detail" src="https://media.invisioncic.com/g327141/monthly_2018_06/347888625_SabineandRittertheAragoDomesandtheApollo11landingsite.png.be53dcfecf5462798ad2c7b13457e0f9.png"
                          class="w-full h-full rounded-full object-cover"
                          onerror="this.onerror=null; this.src='https://placehold.co/800x800/777777/ffffff?text=Detaj+Alternative';"
                          alt="Pamje e zmadhuar e Detit të Qetësisë"/>
                    <div id="tranquility-marker-container" class="absolute top-[40%] left-[55%] transform -translate-x-1/2 -translate-y-1/2">
                        <div class="pulse-marker w-8 h-8 sm:w-10 sm:h-10 rounded-full border-4 border-yellow-300 bg-yellow-300/50 flex items-center justify-center">
                            <div class="w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full bg-yellow-100"></div>
                        </div>
                    </div>
                </div>
                <p id="moon-map-caption" class="image-caption">Harta e Hënës</p>
            </div>
        </section>

        <section id="landing-site" class="section bg-gray-800">
             <h2 class="fun-title mb-4">Deti i Qetësisë</h2>
             <p class="max-w-xl sm:max-w-2xl md:max-w-3xl text-lg sm:text-xl md:text-2xl text-gray-300 mb-8">Këtu u ulën ata! Mblodhën gurë hëne, bënë eksperimente dhe lanë gjurmët e para të këmbëve në Hënë.</p>
             <div class="w-full max-w-md sm:max-w-2xl md:max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-8">
                 <div class="bg-gray-700 p-3 sm:p-4 rounded-2xl">
                    <img src="https://scx1.b-cdn.net/csz/news/800a/2020/apollomoon.jpg" class="w-full h-auto rounded-lg object-cover aspect-[3/2]" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Imazhi+i+Misionit+Apollo';" alt="Misioni Apollo 11 në Hënë">
                    <p class="mt-2 sm:mt-4 font-bold text-base sm:text-xl">Një hap i vogël për njeriun...</p>
                 </div>
                 <div class="bg-gray-700 p-3 sm:p-4 rounded-2xl">
                    <img src="https://nssdc.gsfc.nasa.gov/imgcat/higher_res/apollo/as11_40_5878.jpg" class="w-full h-auto rounded-lg object-cover aspect-[3/2]" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Imazhi+i+Gjurmës';" alt="Gjurmë këmbe në Hënë">
                     <p class="mt-2 sm:mt-4 font-bold text-base sm:text-xl">...një hap gjigant për njerëzimin!</p>
                 </div>
             </div>
        </section>
        
        <section id="noar-adventures" class="section bg-gray-900">
            <h2 class="fun-title mb-8">Aventurat e Noarit në Hapësirë!</h2>
            <p class="max-w-xl sm:max-w-2xl md:max-w-3xl text-lg sm:text-xl md:text-2xl text-gray-300 mb-8">Shikoni disa nga fotot e mrekullueshme të Noarit duke eksploruar me teleskopin e tij dhe fotot që ka bërë!</p>
            <div class="carousel-container">
                <div class="carousel-track">
                    </div>
                <button class="carousel-button prev" onclick="manualCarouselChange(-1)">❮</button>
                <button class="carousel-button next" onclick="manualCarouselChange(1)">❯</button>
            </div>
        </section>

        <section id="quiz-section" class="section bg-gray-800">
            <h2 class="fun-title mb-8">Kuizi i Hapësirës!</h2>
            <button id="start-quiz-btn" class="fun-button text-xl">Starto Kuizin!</button>
            <div id="quiz-active-area" class="w-full max-w-2xl p-6 bg-gray-700 rounded-xl shadow-xl hidden">
                <div id="quiz-question" class="text-2xl text-yellow-400 mb-6 min-h-[60px]">Duke u ngarkuar pyetja...</div>
                <div id="quiz-answer" class="text-xl text-blue-300 hidden mt-4 min-h-[50px]"></div>
                <div id="quiz-timer" class="text-lg text-gray-400 mt-4 mb-2 hidden">Koha e mbetur: <span id="time-left">20</span>s</div>
                <button id="next-question-btn" class="fun-button mt-6">Pyetja Tjetër</button>
            </div>
        </section>

        <footer class="text-center p-8 bg-gray-900 border-t-0"> 
            <h2 class="fun-title text-3xl sm:text-4xl mb-4">Faleminderit që Eksploruat! 🚀</h2>
        </footer>
    </main>
    
    <script async src="https://www.youtube.com/iframe_api"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const splashScreen = document.getElementById('splash-screen');
            const splashButton = document.getElementById('splash-continue-btn');
            const mainContent = document.getElementById('main-content');
            const mainNav = document.getElementById('main-nav');

            if (splashButton && splashScreen && mainContent && mainNav) {
                splashButton.addEventListener('click', () => {
                    splashScreen.classList.add('hidden');
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                        mainContent.classList.add('visible');
                        mainNav.classList.add('visible'); 
                    }, 1000); 
                });
            } else { 
                if(mainContent) mainContent.classList.add('visible');
                if(mainNav) mainNav.classList.add('visible');
            }


            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetElement = document.querySelector(this.getAttribute('href'));
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });

            const telescopeCanvasBtn = document.getElementById('telescope-canvas-btn');
            if (telescopeCanvasBtn) {
                telescopeCanvasBtn.addEventListener('click', startCanvasTelescopeAnimation);
            }
            initializeCanvasTelescope();
             window.addEventListener('resize', () => {
                initializeCanvasTelescope();
                if (canvasAnimFrameId) { 
                    startCanvasTelescopeAnimation(); 
                } else { 
                    drawStaticCanvasElements();
                }
            });


            const phaseBtn = document.getElementById('phase-btn');
            if (phaseBtn) {
                phaseBtn.addEventListener('click', handleNextMoonPhase);
            }
            
            updateMoonPhaseDisplay(); 
            initializeCarousel();
            initializeQuiz();

            const generateLightStoryBtn = document.getElementById('generate-light-story-btn');
            if (generateLightStoryBtn) {
                generateLightStoryBtn.addEventListener('click', generateLightStory);
            }
            const askMoonBtn = document.getElementById('ask-moon-btn');
            if (askMoonBtn) {
                askMoonBtn.addEventListener('click', askMoon);
            }
            
            const markerContainer = document.getElementById('tranquility-marker-container');
            if (markerContainer) {
                markerContainer.addEventListener('click', zoomToTranquility);
            }
        });
        
        const lightFacts = {
            sun: "Dielli është një yll gjigant! Drita e tij merr 8 minuta për të arritur tek ne.",
            lamp: "Llampat përdorin energji elektrike për të bërë dritë që të mund të lexojmë natën.",
            firefly: "Xixëllonjat bëjnë dritën e tyre. Quhet biolumineshencë!",
            flashlight: "Elektrikët e dorës përdorin bateri për të bërë një rreze drite që mund ta drejtojmë."
        };
        
        function toggleLightSource(element, source) {
            document.querySelectorAll('.light-source-card').forEach(card => card.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            const factEl = document.getElementById('light-fact');
            if (factEl) {
                factEl.textContent = lightFacts[source] || "";
            }
        }

        // Canvas Telescope Animation
        let canvas, ctx;
        let canvasAnimationProgress = 0;
        let canvasAnimFrameId;
        let canvasElements = {}; 
        
        const canvasObject = { xPercent: 0.08, yPercent: 0.5, radiusPercent: 0.04 }; 
        const objectiveLensDef = { xPercent: 0.30, yPercent: 0.5, widthPercent: 0.03, heightPercent: 0.6 };
        const focalPointDef = { xPercent: 0.50, yPercent: 0.5 }; 
        const eyepieceLensDef = { xPercent: 0.65, yPercent: 0.5, widthPercent: 0.02, heightPercent: 0.4 }; 
        const magnifiedObjectDef = { xPercent: 0.90, yPercent: 0.5, initialRadiusPercent: 0.04, magnifiedRadiusPercent: 0.10 };

        const rayInitialOffsetYPercent = 0.12; 
        const rayDivergeSpreadFactor = 0.18; 

        function initializeCanvasTelescope() {
            canvas = document.getElementById("telescopeCanvas");
            if (!canvas) {
                return;
            }
            ctx = canvas.getContext("2d");
            
            const container = document.getElementById('telescope-canvas-container');
            if (!container) {
                 return;
            }
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            canvasElements.labelSourceMoon = document.getElementById('label-canvas-source-moon');
            canvasElements.labelObjectiveLens = document.getElementById('label-canvas-objective-lens');
            canvasElements.labelEyepieceLens = document.getElementById('label-canvas-eyepiece-lens');
            canvasElements.labelFocalPoint = document.getElementById('label-canvas-focal-point');
            canvasElements.labelMagnifiedMoon = document.getElementById('label-canvas-magnified-moon');
            
            if(canvasElements.labelSourceMoon) {
                canvasElements.labelSourceMoon.style.left = `${canvasObject.xPercent * canvas.width}px`;
                canvasElements.labelSourceMoon.style.top = `${canvasObject.yPercent * canvas.height + (canvasObject.radiusPercent * canvas.height) + 10}px`;
            }
            if(canvasElements.labelObjectiveLens) {
                canvasElements.labelObjectiveLens.style.left = `${objectiveLensDef.xPercent * canvas.width}px`;
                canvasElements.labelObjectiveLens.style.top = `${objectiveLensDef.yPercent * canvas.height + (objectiveLensDef.heightPercent * canvas.height / 2) + 10}px`;
            }
            if(canvasElements.labelEyepieceLens) {
                canvasElements.labelEyepieceLens.style.left = `${eyepieceLensDef.xPercent * canvas.width}px`;
                canvasElements.labelEyepieceLens.style.top = `${eyepieceLensDef.yPercent * canvas.height + (eyepieceLensDef.heightPercent * canvas.height / 2) + 10}px`;
            }
            if(canvasElements.labelFocalPoint) {
                canvasElements.labelFocalPoint.style.left = `${focalPointDef.xPercent * canvas.width}px`;
                canvasElements.labelFocalPoint.style.top = `${focalPointDef.yPercent * canvas.height + 15}px`;
            }
             if(canvasElements.labelMagnifiedMoon) {
                canvasElements.labelMagnifiedMoon.style.left = `${magnifiedObjectDef.xPercent * canvas.width}px`;
                canvasElements.labelMagnifiedMoon.style.top = `${magnifiedObjectDef.yPercent * canvas.height + (magnifiedObjectDef.magnifiedRadiusPercent * canvas.height) + 10}px`;
            }
            drawStaticCanvasElements(); 
        }

        function drawStaticCanvasElements() {
            if (!ctx || !canvas) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "#E0E0E0"; 
            ctx.beginPath();
            ctx.arc(canvasObject.xPercent * canvas.width, canvasObject.yPercent * canvas.height, canvasObject.radiusPercent * canvas.height, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = "rgba(100, 150, 255, 0.4)";
            ctx.beginPath(); 
            ctx.ellipse(objectiveLensDef.xPercent * canvas.width, objectiveLensDef.yPercent * canvas.height, 
                        objectiveLensDef.widthPercent * canvas.width, objectiveLensDef.heightPercent * canvas.height / 2, 
                        0, 0, Math.PI * 2);
            ctx.fill();

            ctx.beginPath(); 
            ctx.ellipse(eyepieceLensDef.xPercent * canvas.width, eyepieceLensDef.yPercent * canvas.height, 
                        eyepieceLensDef.widthPercent * canvas.width, eyepieceLensDef.heightPercent * canvas.height / 2, 
                        0, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawAnimatedCanvasElements(progress) {
            if (!ctx || !canvas) return;
            drawStaticCanvasElements(); 
            
            ctx.strokeStyle = "#f6e05e"; 
            ctx.lineWidth = 2;

            const sourceX = canvasObject.xPercent * canvas.width;
            const sourceY = canvasObject.yPercent * canvas.height;
            const sourceRadius = canvasObject.radiusPercent * canvas.height;
            
            const objLensX = objectiveLensDef.xPercent * canvas.width;
            const focalX = focalPointDef.xPercent * canvas.width;
            const focalY = focalPointDef.yPercent * canvas.height;
            const eyepieceX = eyepieceLensDef.xPercent * canvas.width;
            const magnifiedX = magnifiedObjectDef.xPercent * canvas.width;
            const magnifiedY = magnifiedObjectDef.yPercent * canvas.height;

            const rayY1_at_source = sourceY - sourceRadius * 0.8; 
            const rayY2_at_source = sourceY + sourceRadius * 0.8; 

            const totalAnimationLength = magnifiedX - sourceX; 
            const currentProgressLength = progress * totalAnimationLength;

            // Phase 1: Parallel rays to objective lens
            let endXPhase1 = Math.min(currentProgressLength, objLensX - sourceX);
            if (endXPhase1 > 0) {
                ctx.beginPath(); ctx.moveTo(sourceX, rayY1_at_source); ctx.lineTo(sourceX + endXPhase1, rayY1_at_source); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(sourceX, rayY2_at_source); ctx.lineTo(sourceX + endXPhase1, rayY2_at_source); ctx.stroke();
            }
            
            // Phase 2: Converging rays from objective lens to focal point
            const startPhase2Progress = objLensX - sourceX;
            if (currentProgressLength > startPhase2Progress) {
                const progressInPhase2 = currentProgressLength - startPhase2Progress;
                const maxLenPhase2 = focalX - objLensX;
                const currentLenPhase2 = Math.min(progressInPhase2, maxLenPhase2);
                const factor2 = Math.min(progressInPhase2 / maxLenPhase2, 1);

                if (currentLenPhase2 > 0) {
                    ctx.beginPath(); ctx.moveTo(objLensX, rayY1_at_source); 
                    ctx.lineTo(objLensX + currentLenPhase2 * Math.cos(Math.atan2(focalY - rayY1_at_source, focalX - objLensX)), 
                               rayY1_at_source + currentLenPhase2 * Math.sin(Math.atan2(focalY - rayY1_at_source, focalX - objLensX)));
                    ctx.stroke();

                    ctx.beginPath(); ctx.moveTo(objLensX, rayY2_at_source); 
                    ctx.lineTo(objLensX + currentLenPhase2 * Math.cos(Math.atan2(focalY - rayY2_at_source, focalX - objLensX)), 
                               rayY2_at_source + currentLenPhase2 * Math.sin(Math.atan2(focalY - rayY2_at_source, focalX - objLensX)));
                    ctx.stroke();
                }
                if (factor2 >= 0.95 && canvasElements.labelFocalPoint) canvasElements.labelFocalPoint.style.opacity = '1';
            }

            // Phase 3: Diverging rays from focal point through eyepiece
            const startPhase3Progress = startPhase2Progress + (focalX - objLensX);
            if (currentProgressLength > startPhase3Progress) {
                const progressInPhase3 = currentProgressLength - startPhase3Progress;
                const maxLenPhase3 = magnifiedX - focalX; 
                const currentLenPhase3 = Math.min(progressInPhase3, maxLenPhase3);
                const factor3 = Math.min(progressInPhase3 / maxLenPhase3, 1);

                const spreadY = rayDivergeSpreadFactor * canvas.height * factor3;

                if (currentLenPhase3 > 0) {
                    ctx.beginPath(); ctx.moveTo(focalX, focalY);
                    ctx.lineTo(focalX + currentLenPhase3 * Math.cos(Math.atan2(-spreadY, magnifiedX - focalX)), 
                               focalY + currentLenPhase3 * Math.sin(Math.atan2(-spreadY, magnifiedX - focalX)));
                    ctx.stroke();

                    ctx.beginPath(); ctx.moveTo(focalX, focalY);
                    ctx.lineTo(focalX + currentLenPhase3 * Math.cos(Math.atan2(spreadY, magnifiedX - focalX)), 
                               focalY + currentLenPhase3 * Math.sin(Math.atan2(spreadY, magnifiedX - focalX)));
                    ctx.stroke();
                }

                if (factor3 > 0.5) { 
                    const currentRadius = magnifiedObjectDef.initialRadiusPercent * canvas.height + 
                                       (magnifiedObjectDef.magnifiedRadiusPercent - magnifiedObjectDef.initialRadiusPercent) * canvas.height * Math.min((factor3 - 0.5)/0.5, 1) ;
                    ctx.fillStyle = "#E0E0E0";
                    ctx.beginPath();
                    ctx.arc(magnifiedX, magnifiedY, currentRadius, 0, Math.PI * 2);
                    ctx.fill();
                    if (canvasElements.labelMagnifiedMoon) canvasElements.labelMagnifiedMoon.style.opacity = '1';
                }
            }
        }
        
        function startCanvasTelescopeAnimationLoop() {
            if (!ctx || !canvas) return;
            
            let currentProgress = canvasAnimationProgress;
            if (currentProgress > 1) currentProgress = 1;

            drawAnimatedCanvasElements(currentProgress);
            
            if (canvasAnimationProgress < 1) { 
                canvasAnimationProgress += 0.008; 
                canvasAnimFrameId = requestAnimationFrame(startCanvasTelescopeAnimationLoop);
            } else {
                // Animation complete, keep final frame visible
                drawAnimatedCanvasElements(1); 
                if (canvasElements.labelFocalPoint) canvasElements.labelFocalPoint.style.opacity = '1'; 
                if (canvasElements.labelMagnifiedMoon) canvasElements.labelMagnifiedMoon.style.opacity = '1';
                 // No automatic reset, wait for button click to call startCanvasTelescopeAnimation which includes reset
            }
        }
        
        function resetCanvasToInitialState() { 
            if (!ctx || !canvas) return;
            if (canvasAnimFrameId) {
                cancelAnimationFrame(canvasAnimFrameId);
                canvasAnimFrameId = null;
            }
            canvasAnimationProgress = 0; 
            drawStaticCanvasElements(); 
            if(canvasElements.labelSourceMoon) canvasElements.labelSourceMoon.style.opacity = '1';
            if(canvasElements.labelObjectiveLens) canvasElements.labelObjectiveLens.style.opacity = '1';
            if(canvasElements.labelEyepieceLens) canvasElements.labelEyepieceLens.style.opacity = '1';
            if (canvasElements.labelFocalPoint) canvasElements.labelFocalPoint.style.opacity = '0';
            if (canvasElements.labelMagnifiedMoon) canvasElements.labelMagnifiedMoon.style.opacity = '0';
        }


        function startCanvasTelescopeAnimation() {
            if (canvasAnimFrameId) { 
                cancelAnimationFrame(canvasAnimFrameId);
            }
            resetCanvasToInitialState(); 
            canvasAnimationProgress = 0; 
            
            if(canvasElements.labelSourceMoon) canvasElements.labelSourceMoon.style.opacity = '1';
            if(canvasElements.labelObjectiveLens) canvasElements.labelObjectiveLens.style.opacity = '1';
            if(canvasElements.labelEyepieceLens) canvasElements.labelEyepieceLens.style.opacity = '1';
            if(canvasElements.labelFocalPoint) canvasElements.labelFocalPoint.style.opacity = '0';
            if(canvasElements.labelMagnifiedMoon) canvasElements.labelMagnifiedMoon.style.opacity = '0';
            
            startCanvasTelescopeAnimationLoop();
        }

        function drawFinalTelescopeView() { // This function is called when animation reaches 100%
            if (!ctx || !canvas) return;
            // This will draw the final state including all rays as per the logic in drawAnimatedCanvasElements(1)
            drawAnimatedCanvasElements(1); 
            if (canvasElements.labelFocalPoint) canvasElements.labelFocalPoint.style.opacity = '1';
            if (canvasElements.labelMagnifiedMoon) canvasElements.labelMagnifiedMoon.style.opacity = '1';
        }


        let moonPhaseIndex = 0; 
        const moonPhasesData = [
            { emoji: '🌓', name: 'Çereku i Parë', angle: 0 },      
            { emoji: '🌔', name: 'Gunga Rritëse', angle: 45 },
            { emoji: '🌕', name: 'Hëna e Plotë', angle: 90 },
            { emoji: '🌖', name: 'Gunga Zbritëse', angle: 135 },
            { emoji: '🌗', name: 'Çereku i Fundit', angle: 180 }, 
            { emoji: '🌘', name: 'Draperi Zbritës', angle: 225 }, 
            { emoji: '🌑', name: 'Hëna e Re', angle: 270 },
            { emoji: '🌒', name: 'Draperi Rritës', angle: 315 }
        ];
        
        let currentVisualOrbitAngle = moonPhasesData[moonPhaseIndex].angle;

        function updateMoonPhaseDisplay() {
            const phase = moonPhasesData[moonPhaseIndex];
            const moonPhaseDisplayEl = document.getElementById('moon-phase-display');
            const moonPhaseNameEl = document.getElementById('moon-phase-name');
            const moonObjectEl = document.getElementById('moon-object');

            if (moonPhaseDisplayEl) moonPhaseDisplayEl.textContent = phase.emoji;
            if (moonPhaseNameEl) moonPhaseNameEl.textContent = phase.name;
            if (moonObjectEl) moonObjectEl.textContent = phase.emoji; 
            
            const moonOrbitEl = document.getElementById('moon-orbit');
            if (moonOrbitEl) moonOrbitEl.style.transform = `rotate(${currentVisualOrbitAngle}deg)`;
        }

        function handleNextMoonPhase() {
            const previousCanonicalAngle = moonPhasesData[moonPhaseIndex].angle;
            moonPhaseIndex = (moonPhaseIndex + 1) % moonPhasesData.length;
            const nextCanonicalAngle = moonPhasesData[moonPhaseIndex].angle;

            let angleDifference;
            if (nextCanonicalAngle < previousCanonicalAngle) { 
                angleDifference = (360 - previousCanonicalAngle) + nextCanonicalAngle;
            } else {
                angleDifference = nextCanonicalAngle - previousCanonicalAngle;
            }
            currentVisualOrbitAngle += angleDifference;

            updateMoonPhaseDisplay();
        }

        function zoomToTranquility() {
            console.log("zoomToTranquility function called!"); 
            const moonMapImage = document.getElementById('moon-map-image');
            const detailImage = document.getElementById('sea-of-tranquility-detail');
            const markerContainer = document.getElementById('tranquility-marker-container');
            const landingSiteSection = document.getElementById('landing-site');
            const captionElement = document.getElementById('moon-map-caption');

            if (moonMapImage && detailImage && markerContainer && landingSiteSection && captionElement) {
                console.log("All elements for zoom found.");
                const originX = '55%'; 
                const originY = '40%';
                
                moonMapImage.style.transformOrigin = `${originX} ${originY}`;
                detailImage.style.transformOrigin = `${originX} ${originY}`;
                detailImage.style.pointerEvents = 'auto'; 
                
                moonMapImage.style.opacity = '0'; 
                console.log("Moon map opacity set to 0");

                markerContainer.style.opacity = '0'; 
                if(captionElement) captionElement.textContent = 'Deti i Qetësisë (Pamje e Zmadhuar)';

                detailImage.classList.add('visible-zoomed');
                console.log("Detail image class 'visible-zoomed' added.");


                setTimeout(() => {
                    if (landingSiteSection) {
                        landingSiteSection.scrollIntoView({ behavior: 'smooth' });
                        console.log("Scrolling to landing site.");
                    }
                }, 2500); 

                setTimeout(() => {
                    moonMapImage.style.opacity = '1'; 
                    detailImage.classList.remove('visible-zoomed');
                     detailImage.style.pointerEvents = 'none';
                    markerContainer.style.opacity = '1'; 
                    if(captionElement) captionElement.textContent = 'Harta e Hënës';
                    console.log("Zoom elements reset.");
                }, 4000); 
            } else {
                console.error("One or more elements for zoomToTranquility not found:", {
                    moonMapImage: !!moonMapImage, 
                    detailImage: !!detailImage, 
                    markerContainer: !!markerContainer, 
                    landingSiteSection: !!landingSiteSection, 
                    captionElement: !!captionElement
                });
            }
        }

        const carouselTrack = document.querySelector('.carousel-track');
        const carouselContainer = document.querySelector('.carousel-container');
        const placeholderImageSources = [
            "images/noari_telescope1.webp",
            "images/noari_telescope2.webp",
            "images/noari_hena.webp",
            "images/noari_telescope3.webp",
            "images/noari_space.webp" 
        ];
        const slideWidth = 500; 
        const slideMargin = 16; 
        const totalSlideWidth = slideWidth + slideMargin;
        let currentTrackPosition = 0;
        let scrollSpeed = 0.8; 
        let isCarouselPaused = false;
        let carouselAnimFrameId;

        function populateCarousel() {
            if (!carouselTrack) return;
            carouselTrack.innerHTML = ''; 
            const allImages = [...placeholderImageSources, ...placeholderImageSources]; 
            allImages.forEach(src => {
                const slideDiv = document.createElement('div');
                slideDiv.classList.add('carousel-slide');
                const img = document.createElement('img');
                img.src = src;
                img.alt = "Imazh nga aventurat e Noarit"; 
                img.onerror = function() { this.onerror=null; this.src='https://placehold.co/800x500/777777/ffffff?text=Problem+me+Imazhin+(webp)'; };
                slideDiv.appendChild(img);
                carouselTrack.appendChild(slideDiv);
            });
            carouselTrack.style.width = `${totalSlideWidth * allImages.length}px`;
        }

        function autoScrollCarousel() {
            if (!isCarouselPaused && carouselTrack) {
                currentTrackPosition -= scrollSpeed;
                if (currentTrackPosition <= -(totalSlideWidth * placeholderImageSources.length)) {
                    carouselTrack.style.transition = 'none'; 
                    currentTrackPosition += (totalSlideWidth * placeholderImageSources.length);
                    carouselTrack.style.transform = `translateX(${currentTrackPosition}px)`;
                    void carouselTrack.offsetWidth; 
                    carouselTrack.style.transition = ''; 
                } else {
                    carouselTrack.style.transform = `translateX(${currentTrackPosition}px)`;
                }
            }
            carouselAnimFrameId = requestAnimationFrame(autoScrollCarousel);
        }
        
        function manualCarouselChange(direction) {
            if (!carouselTrack) return;
            isCarouselPaused = true; 
            cancelAnimationFrame(carouselAnimFrameId);

            const numOriginalSlides = placeholderImageSources.length;
            let currentEffectiveIndex = Math.floor(Math.abs(currentTrackPosition) / totalSlideWidth);
            
            currentEffectiveIndex += direction;
            currentTrackPosition = -(currentEffectiveIndex * totalSlideWidth);

            const totalOriginalSetWidth = totalSlideWidth * numOriginalSlides;
            if (currentTrackPosition < -totalOriginalSetWidth) { 
                currentTrackPosition += totalOriginalSetWidth; 
            } else if (currentTrackPosition > 0) { 
                currentTrackPosition -= totalOriginalSetWidth; 
                if (currentTrackPosition === 0 && direction === -1) currentTrackPosition = -totalOriginalSetWidth + totalSlideWidth;
            }
            
            carouselTrack.style.transition = 'transform 0.5s ease-in-out'; 
            carouselTrack.style.transform = `translateX(${currentTrackPosition}px)`;
            
            setTimeout(() => {
                if (carouselTrack) carouselTrack.style.transition = 'none'; 
                if (carouselContainer && !carouselContainer.matches(':hover')) { 
                    isCarouselPaused = false;
                    autoScrollCarousel();
                }
            }, 500); 
        }

        function initializeCarousel() {
            populateCarousel();
            if (carouselContainer && carouselTrack) {
                carouselContainer.addEventListener('mouseenter', () => {
                    isCarouselPaused = true;
                    if (carouselAnimFrameId) cancelAnimationFrame(carouselAnimFrameId);
                });
                carouselContainer.addEventListener('mouseleave', () => {
                    isCarouselPaused = false;
                    if (carouselTrack) carouselTrack.style.transition = 'none'; 
                    autoScrollCarousel(); 
                });
                if (carouselTrack) carouselTrack.style.transition = 'none'; 
                autoScrollCarousel(); 
            }
        }

        // YouTube Player API
        let apolloVideoPlayer;
        const videoId = 'g5aPoRtF2vw'; 

        function onYouTubeIframeAPIReady() {
            apolloVideoPlayer = new YT.Player('apollo-video-player', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'playsinline': 1,
                    'modestbranding': 1,
                    'rel': 0,
                    'controls': 0,
                    'origin': window.location.origin 
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange 
                }
            });
        }

        function onPlayerReady(event) {
            setupVideoObserver();
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
                const moonMapElement = document.getElementById('moon-map-container'); 
                if (moonMapElement) {
                    moonMapElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                }
            }
        }

        function setupVideoObserver() {
            const videoContainer = document.getElementById('video-player-container');
            if (!videoContainer || !apolloVideoPlayer) return;

            const observerOptions = {
                root: null, 
                rootMargin: '0px',
                threshold: 0.5 
            };

            const observerCallback = (entries, observer) => {
                entries.forEach(entry => {
                    if (typeof apolloVideoPlayer.playVideo !== 'function' || typeof apolloVideoPlayer.pauseVideo !== 'function') {
                        return;
                    }
                    if (entry.isIntersecting) {
                        apolloVideoPlayer.playVideo();
                    } else {
                        if (apolloVideoPlayer.getPlayerState && apolloVideoPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                            apolloVideoPlayer.pauseVideo();
                        }
                    }
                });
            };

            const videoObserver = new IntersectionObserver(observerCallback, observerOptions);
            videoObserver.observe(videoContainer);
        }

        // "Fake" AI Functions
        const lightStories = [
            "Njëherë e një kohë, në një galaktikë shumë të largët, jetonte një yll i vogël i quajtur Lumen. Lumen ishte plot me dritë të artë dhe ëndrra e tij më e madhe ishte të ndriçonte një planet të vogël blu që e shihte nga larg. Çdo mëngjes, Lumen merrte frymë thellë dhe lëshonte rrezet e tij të para, si shigjeta të arta, që vraponin nëpër errësirën e hapësirës. Kur arrinin në planetin blu, ato zgjonin lulet, i jepnin ngrohtësi kafshëve dhe i ndihmonin fëmijët të shihnin rrugën për në shkollë. Drita e Lumenit ishte si një përqafim i ngrohtë për të gjithë!",
            "Drita është si një piktore magjike! Imagjino që ajo ka një kuti plot me ngjyra vezulluese. Kur kalon përmes pikave të shiut, ajo pikturon një ylber të mrekullueshëm në qiell. Kur prek një flluskë sapuni, ajo e bën të shkëlqejë me të gjitha ngjyrat e ylberit. Dhe kur ti sheh veten në pasqyrë, është Drita ajo që kërcente nga fytyra jote, tek pasqyra, dhe pastaj përsëri tek sytë e tu, duke të lejuar të shohësh buzëqeshjen tënde!",
            "Në një pyll të errët, jetonte një xixëllonjë e vogël e quajtur Pip. Pipi kishte një dritë të vogël në bishtin e saj, por ishte shumë e turpshme për ta treguar. Një natë, një ketër i vogël humbi rrugën. Pipi mori guximin, ndezi dritën e saj të vogël dhe e ndihmoi ketrin të gjente familjen e tij. Që nga ajo ditë, Pipi e kuptoi se edhe drita më e vogël mund të bëjë një ndryshim të madh dhe të ndriçojë errësirën.",
            "A e dije se drita nga Dielli udhëton shumë, shumë shpejt për të ardhur tek ne? Është si një makinë garash super e shpejtë, por shumë herë më e shpejtë se çdo makinë që ke parë! I duhen vetëm 8 minuta dritës së Diellit për të përshkuar gjithë atë rrugë të gjatë nga Dielli deri tek Toka. Kështu, kur ti sheh Diellin, ti po sheh dritën që u nis nga ai 8 minuta më parë!",
            "Drita nuk është vetëm për të parë, por edhe për të na mbajtur ngrohtë! Rrezet e Diellit sjellin ngrohtësi në Tokë, duke bërë që bimët të rriten dhe ne të ndihemi mirë kur luajmë jashtë. Edhe llambat në shtëpinë tënde lëshojnë pak ngrohtësi bashkë me dritën. Drita është një mike e fuqishme dhe e ngrohtë!",
            "Kur ti ndez një elektrik dore në errësirë, drita del si një shpatë e ndritshme, duke prerë errësirën dhe duke të treguar se çfarë ka përreth. Ajo udhëton në vija të drejta derisa të përplaset me diçka, si muri apo një lodër. Kjo është arsyeja pse mund të bësh hije me duart e tua – sepse ti e bllokon rrugën e dritës!"
        ];
        let currentLightStoryIndex = 0;

        function generateLightStory() {
            const lightStoryOutput = document.getElementById('light-story-output');
            if (lightStoryOutput) {
                lightStoryOutput.classList.remove('hidden');
                lightStoryOutput.innerHTML = `<p>${lightStories[currentLightStoryIndex]}</p>`;
                currentLightStoryIndex = (currentLightStoryIndex + 1) % lightStories.length;
            }
        }
        
        const specificMoonAnswers = {
            "cka eshte hena": "Unë jam Hëna! Jam një top i madh shkëmbor që rrotullohem rreth planetit tuaj të bukur, Tokës. Nuk kam dritën time, por shkëlqej kur Dielli më ndriçon!",
            "si eshte krijuar hena": "Shkencëtarët mendojnë se shumë kohë më parë, një planet gjigant sa Marsi u përplas me Tokën! Nga kjo përplasje e madhe, u krijova unë, Hëna, nga copat që fluturuan në hapësirë.",
            "sa e madhe eshte hena": "Jam goxha e madhe! Diametri im është rreth 3,474 kilometra. Kjo do të thotë që nëse do të mund të ecje rreth ekuatorit tim, do të bëje një udhëtim shumë të gjatë!",
            "sa eshte distanca e henes nga toka": "Jam mjaft larg! Mesatarisht, jam rreth 384,400 kilometra larg Tokës. Është aq larg sa mund të vendosësh 30 planete Toka njëra pas tjetrës mes nesh!"
        };

        const genericMoonAnswers = [
            "A e dije se unë nuk kam atmosferë si Toka? Kjo do të thotë që nuk ka erë apo mot tek unë, dhe gjurmët e këmbëve të astronautëve që më vizituan do të qëndrojnë aty për miliona vjet!",
            "Unë kam 'dete' por ato nuk janë me ujë! Janë fusha të mëdha, të errëta, të formuara nga llava vullkanike shumë kohë më parë. Astronautët e Apollo 11 u ulën në njërin prej tyre, Detin e Qetësisë.",
            "Unë i shkaktoj baticat dhe zbaticat në oqeanet e Tokës! Forca ime e gravitetit tërheq ujin, duke bërë që ai të ngrihet dhe të ulet.",
            "Nga Toka, ju gjithmonë shihni të njëjtën anë timen! Kjo ndodh sepse unë rrotullohem rreth vetes me të njëjtën shpejtësi me të cilën rrotullohem rreth Tokës.",
            "Kam shumë kratere! Ato janë krijuar nga përplasjet e meteoritëve dhe asteroidëve gjatë miliarda viteve.",
            "Ndonjëherë më quajnë 'Selena' ose 'Luna'. Janë emra të bukur, apo jo?"
        ];
        let currentGenericMoonAnswerIndex = 0;

        function askMoon() {
            const moonQuestionInput = document.getElementById('moon-question-input');
            const moonAnswerOutput = document.getElementById('moon-answer-output');
            if (!moonAnswerOutput) return;

            const question = moonQuestionInput.value.trim().toLowerCase().replace(/[^\w\s]/gi, '');
            moonAnswerOutput.classList.remove('hidden');
            let foundSpecificAnswer = false;

            if (question) { 
                for (const key in specificMoonAnswers) {
                    if (question.includes(key.replace(/[^\w\s]/gi, ''))) { 
                        moonAnswerOutput.innerHTML = `<p>${specificMoonAnswers[key]}</p>`;
                        foundSpecificAnswer = true;
                        break;
                    }
                }
            }

            if (!foundSpecificAnswer) { 
                moonAnswerOutput.innerHTML = `<p>${genericMoonAnswers[currentGenericMoonAnswerIndex]}</p>`;
                currentGenericMoonAnswerIndex = (currentGenericMoonAnswerIndex + 1) % genericMoonAnswers.length;
            }
            
            if(moonQuestionInput) moonQuestionInput.value = ''; 
        }

        // Quiz Section Logic
        const quizData = [
            { question: "Nga vjen drita kryesore që ndriçon Tokën tonë?", answer: "Nga Dielli!" },
            { question: "Si quhet mjeti që përdorim për të parë Hënën dhe yjet më afër?", answer: "Teleskopi!" },
            { question: "A e ndryshon Hëna formën e saj vërtet?", answer: "Jo, ajo që ne shohim është vetëm pjesa e ndriçuar nga Dielli!" },
            { question: "Si quhej misioni i parë që uli njerëzit në Hënë?", answer: "Apollo 11!" },
            { question: "Në cilin 'det' në Hënë u ulën astronautët e Apollo 11?", answer: "Në Detin e Qetësisë!" }
        ];
        let currentQuestionIndex = 0;
        let quizTimerInterval;
        let timeLeft = 20; 
        let quizObserver; 
        let quizSectionVisible = false; 
        let quizCompleted = false; 

        function initializeQuiz() {
            const startQuizBtn = document.getElementById('start-quiz-btn');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const quizActiveArea = document.getElementById('quiz-active-area');
            
            if (startQuizBtn && nextQuestionBtn && quizActiveArea) {
                startQuizBtn.addEventListener('click', () => {
                    startQuizBtn.classList.add('hidden');
                    quizActiveArea.classList.remove('hidden');
                    currentQuestionIndex = 0; 
                    quizCompleted = false;
                    showNextQuizQuestion();
                });

                nextQuestionBtn.addEventListener('click', () => {
                    if (quizTimerInterval) clearInterval(quizTimerInterval); 
                    const currentBtn = document.getElementById('next-question-btn'); // Get fresh reference
                    if (currentBtn.textContent === "Rifillo Kuizin") {
                        quizActiveArea.classList.add('hidden');
                        startQuizBtn.classList.remove('hidden');
                        document.getElementById('quiz-question').textContent = "Duke u ngarkuar pyetja..."; 
                        document.getElementById('quiz-answer').classList.add('hidden');
                        document.getElementById('quiz-timer').classList.add('hidden');
                        currentQuestionIndex = 0; 
                        quizCompleted = false; 
                        return; 
                    }
                    showNextQuizQuestion();
                });
            }
            setupQuizObserver();
        }
        
        function startQuizTimer() {
            const timerDisplay = document.getElementById('time-left');
            const timerContainer = document.getElementById('quiz-timer');

            if (!timerDisplay || !timerContainer || !quizSectionVisible || quizCompleted) { 
                 if (quizTimerInterval) clearInterval(quizTimerInterval);
                 if (quizCompleted && timerContainer) timerContainer.classList.add('hidden');
                return;
            }

            timerContainer.classList.remove('hidden');
            timeLeft = 20; 
            timerDisplay.textContent = timeLeft;
            
            if (quizTimerInterval) clearInterval(quizTimerInterval); 

            quizTimerInterval = setInterval(() => {
                if (!quizSectionVisible || quizCompleted) { 
                    clearInterval(quizTimerInterval);
                    return;
                }
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(quizTimerInterval);
                    showQuizAnswer();
                }
            }, 1000);
        }

        function showNextQuizQuestion() {
            const questionEl = document.getElementById('quiz-question');
            const answerEl = document.getElementById('quiz-answer');
            const nextBtn = document.getElementById('next-question-btn');
            const timerContainer = document.getElementById('quiz-timer');

            if (!questionEl || !answerEl || !nextBtn || !timerContainer) return;
            
            quizCompleted = false; 

            answerEl.classList.add('hidden');
            answerEl.textContent = '';
            nextBtn.disabled = true;
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            timerContainer.classList.add('hidden'); 

            if (currentQuestionIndex >= quizData.length) {
                quizCompleted = true; 
                questionEl.textContent = "Kuizi përfundoi! Shpresojmë të keni mësuar gjëra të reja!";
                nextBtn.textContent = "Rifillo Kuizin";
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                timerContainer.classList.add('hidden'); 
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                return;
            }
            
            nextBtn.textContent = "Pyetja Tjetër";
            questionEl.textContent = quizData[currentQuestionIndex].question;
            
            setTimeout(() => {
                if(quizSectionVisible && !quizCompleted) { 
                   startQuizTimer();
                } else if (!quizCompleted) { 
                    document.getElementById('time-left').textContent = 20;
                    timerContainer.classList.remove('hidden'); 
                }
            }, 1500); 
        }

        function showQuizAnswer() {
            const answerEl = document.getElementById('quiz-answer');
            const nextBtn = document.getElementById('next-question-btn');
            const timerContainer = document.getElementById('quiz-timer');

            if (!answerEl || !nextBtn || !timerContainer) return;
            
            if (quizTimerInterval) clearInterval(quizTimerInterval); 
            timerContainer.classList.add('hidden'); 
            answerEl.textContent = `Përgjigja: ${quizData[currentQuestionIndex].answer}`;
            answerEl.classList.remove('hidden');
            
            currentQuestionIndex++;
            nextBtn.disabled = false;
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function setupQuizObserver() {
            const quizSection = document.getElementById('quiz-section');
            if (!quizSection) return;

            const observerOptions = {
                root: null,
                rootMargin: '0px',
                threshold: 0.1 
            };

            quizObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    quizSectionVisible = entry.isIntersecting;
                    const quizActiveArea = document.getElementById('quiz-active-area');
                    if (!quizActiveArea || quizActiveArea.classList.contains('hidden')) return; 

                    if (entry.isIntersecting) {
                        if (quizCompleted) { 
                             document.getElementById('quiz-timer').classList.add('hidden');
                             return; 
                        }
                        if(document.getElementById('quiz-question').textContent === "Duke u ngarkuar pyetja..." || 
                           (document.getElementById('next-question-btn').textContent === "Rifillo Kuizin" && currentQuestionIndex === 0) ){
                            showNextQuizQuestion(); 
                        } 
                        else if (document.getElementById('quiz-answer').classList.contains('hidden') && !quizCompleted) {
                           startQuizTimer(); 
                        }
                    } else {
                        if (quizTimerInterval) {
                            clearInterval(quizTimerInterval); 
                        }
                    }
                });
            }, observerOptions);
            quizObserver.observe(quizSection);
        }

    </script>

    <!-- Interactive Solar System Section -->
    <section class="section bg-gray-900">
        <h2 class="fun-title mb-8">Sistemi Diellor Interaktiv</h2>
        <div id="solar-system-container" class="w-full h-[600px] rounded-lg shadow-2xl mb-8 bg-black"></div>
        <p class="text-lg mb-4">Eksploro sistemin tonë diellor në 3D! Përdor kontrollet për të rrotulluar dhe zmadhuar pamjen.</p>
    </section>

    <!-- Night Sky Simulator Section -->
    <section class="section bg-gray-900">
        <h2 class="fun-title mb-8">Qielli i Natës nga Kosova</h2>
        <div id="night-sky-container" class="w-full h-[600px] rounded-lg shadow-2xl mb-8 bg-black"></div>
        <p class="text-lg mb-4">Zbulo yjet dhe yjësitë që shihen nga Kosova! Përdor kontrollet për të eksploruar qiellin e natës.</p>
    </section>

</body>
</html>
