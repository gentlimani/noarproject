<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drita, TeleskopÃ«t dhe HÃ«na JonÃ« e Mrekullueshme!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Marker Felt', sans-serif;
            background-color: #1a202c;
            color: #f7fafc;
        }
        .section {
            min-height: 100vh;
            padding: 4rem 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border-bottom: 2px dashed #4a5568;
        }
        .fun-title {
            font-size: 3rem;
            font-weight: bold;
            color: #f6e05e;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        @media (min-width: 768px) {
            .fun-title {
                font-size: 5rem;
            }
        }
        .fun-button {
            background-color: #ed8936;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .fun-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.3);
        }
        .icon-nav {
            position: fixed;
            top: 50%;
            left: 1rem;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: rgba(45, 55, 72, 0.8);
            padding: 1rem;
            border-radius: 1.5rem;
            z-index: 50;
        }
        .icon-nav a {
            font-size: 2rem;
            transition: transform 0.2s;
        }
        .icon-nav a:hover {
            transform: scale(1.2);
        }
        .light-source-card {
            border: 4px solid #4a5568;
            transition: all 0.3s;
        }
        .light-source-card.active {
            border-color: #f6e05e;
            transform: scale(1.05);
            box-shadow: 0 0 20px #f6e05e;
        }
        
        #telescope-canvas-container {
            width: 100%;
            max-width: 700px; 
            height: 350px; /* Adjusted height */
            background-color: #0a0f1a; 
            border-radius: 1rem;
            margin-bottom: 1rem;
            position: relative; 
        }
        #telescopeCanvas { /* Renamed from telescope-canvas */
            display: block; 
            width: 100%;
            height: 100%;
            border-radius: 1rem; 
        }
         .label { /* From user's provided code */
            position: absolute;
            color: #fff;
            font-size: 14px;
            pointer-events: none;
            opacity: 0; /* Initially hidden, controlled by JS */
            transition: opacity 0.5s ease-in-out;
        }


        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .pulse-marker {
            animation: pulse 2s infinite;
            transition: opacity 0.5s ease-out;
        }
        .video-container {
            width: 100%;
            max-width: 640px;
            margin: 2rem auto;
            aspect-ratio: 16 / 9;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        #moon-map-container {
            overflow: hidden; 
        }
        #moon-map-image {
            transition: transform 1.5s ease-in-out, opacity 0.8s ease-in-out 0.3s;
            transform-origin: 55% 40%; 
        }
        #moon-map-image.zoomed-in {
            transform: scale(3); 
        }
        #sea-of-tranquility-detail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%; 
            opacity: 0;
            transition: opacity 0.8s ease-in-out, transform 1.5s ease-in-out;
            transform-origin: 55% 40%; 
            transform: scale(1); 
            pointer-events: none; 
        }
        #sea-of-tranquility-detail.visible-zoomed {
            opacity: 1;
            transform: scale(3); 
        }
        .image-caption {
            margin-top: 0.75rem; 
            font-size: 1.125rem; 
            color: #cbd5e0; 
            font-weight: 600; 
        }
        .carousel-container {
            width: 100%;
            max-width: 1250px; 
            margin: 2rem auto;
            position: relative;
            overflow: hidden;
            padding: 1rem 0; 
        }
        .carousel-track {
            display: flex;
        }
        .carousel-slide {
            flex: 0 0 auto; 
            width: 500px; 
            margin-right: 1rem; 
            box-sizing: border-box;
        }
        .carousel-slide img {
            width: 100%;
            height: 310px; 
            object-fit: cover;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: block;
        }
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(237, 137, 54, 0.9); 
            color: white;
            border: none;
            padding: 0.5rem; 
            width: 2.5rem; 
            height: 2.5rem; 
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            opacity: 0; 
            transition: opacity 0.3s ease-in-out;
        }
        .carousel-container:hover .carousel-button {
            opacity: 1; 
        }
        .carousel-button.prev {
            left: -10px; 
        }
        .carousel-button.next {
            right: -10px; 
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <nav class="icon-nav hidden md:flex">
        <a href="#intro" title="Hyrja">ğŸŒŸ</a>
        <a href="#light" title="Drita">ğŸ’¡</a>
        <a href="#telescope" title="Teleskopi">ğŸ”­</a>
        <a href="#moon" title="HÃ«na">ğŸŒ™</a>
        <a href="#apollo" title="Apollo 11">ğŸš€</a>
        <a href="#noar-adventures" title="Aventurat e Noarit">ğŸ–¼ï¸</a>
    </nav>

    <main>
        <section id="intro" class="section bg-gray-900">
            <h1 class="fun-title mb-4">Drita, TeleskopÃ«t,</h1>
            <h1 class="fun-title mb-8">dhe HÃ«na JonÃ« e Mrekullueshme!</h1>
            <p class="text-2xl text-gray-300 mb-4">NjÃ« projekt shkollor nga njÃ« astronaut i ardhshÃ«m!</p>
            <p class="text-xl text-gray-400 mb-6">Noar Limani II-4</p>
            <a href="#light" class="fun-button text-2xl">Fillo Eksplorimin! ğŸ‘‡</a>
        </section>

        <section id="light" class="section">
            <h2 class="fun-title mb-4">Ã‡farÃ« Ã«shtÃ« Drita?</h2>
            <p class="max-w-2xl text-xl md:text-2xl text-gray-300 mb-8">Drita na ndihmon tÃ« shohim gjithÃ§ka! Ajo vjen nga gjÃ«rat e ndritshme dhe udhÃ«ton super shpejt. Kliko mbi figura pÃ«r tÃ« mÃ«suar mÃ« shumÃ«!</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
                <div class="light-source-card bg-gray-800 p-6 rounded-2xl cursor-pointer" onclick="toggleLightSource(this, 'sun')">
                    <div class="text-6xl mb-4">â˜€ï¸</div>
                    <h3 class="text-2xl font-bold text-yellow-300">Dielli</h3>
                </div>
                <div class="light-source-card bg-gray-800 p-6 rounded-2xl cursor-pointer" onclick="toggleLightSource(this, 'lamp')">
                    <div class="text-6xl mb-4">ğŸ’¡</div>
                    <h3 class="text-2xl font-bold text-blue-300">NjÃ« LlampÃ«</h3>
                </div>
                 <div class="light-source-card bg-gray-800 p-6 rounded-2xl cursor-pointer" onclick="toggleLightSource(this, 'firefly')">
                    <div class="text-6xl mb-4">ğŸ¦Ÿ</div>
                    <h3 class="text-2xl font-bold text-green-300">NjÃ« XixÃ«llonjÃ«</h3>
                </div>
                 <div class="light-source-card bg-gray-800 p-6 rounded-2xl cursor-pointer" onclick="toggleLightSource(this, 'flashlight')">
                    <div class="text-6xl mb-4">ğŸ”¦</div>
                    <h3 class="text-2xl font-bold text-purple-300">NjÃ« Elektrik Dore</h3>
                </div>
            </div>
            <div id="light-fact" class="mt-8 text-2xl h-12 text-orange-400 font-bold"></div>
        </section>

        <section id="telescope" class="section">
            <h2 class="fun-title mb-4">Sy Super tÃ« FuqishÃ«m!</h2>
            <p class="max-w-2xl text-xl md:text-2xl text-gray-300 mb-8">TeleskopÃ«t pÃ«rdorin THJERRÃ‹ZA pÃ«r tÃ« pÃ«rthyer dritÃ«n dhe pÃ«r t'i bÃ«rÃ« gjÃ«rat e largÃ«ta tÃ« duken mÃ« tÃ« mÃ«dha. Shtyp butonin pÃ«r tÃ« parÃ« se si!</p>
            <div id="telescope-canvas-container">
                <canvas id="telescopeCanvas"></canvas>
                <div class="label" id="focalLabel">Pika Fokale</div>
            </div>
            <button id="telescope-canvas-btn" class="fun-button mt-4">Shiko si funksionon!</button>
        </section>

        <section id="moon" class="section">
            <h2 class="fun-title mb-4">HÃ«na JonÃ« Misterioze</h2>
            <p class="max-w-2xl text-xl md:text-2xl text-gray-300 mb-8">A e ke vÃ«nÃ« re qÃ« HÃ«na ndryshon formÃ«? KÃ«to quhen Faza! Nuk Ã«shtÃ« magji, thjesht varet se si Dielli e ndriÃ§on atÃ«.</p>
            <div class="flex flex-col md:flex-row items-center justify-center gap-8 w-full max-w-5xl">
                <div class="relative w-64 h-64 md:w-80 md:h-80">
                    <div class="absolute inset-0 border-2 border-dashed border-gray-600 rounded-full"></div>
                    <div id="moon-earth" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-7xl md:text-8xl">ğŸŒ</div>
                    <div id="moon-orbit" class="absolute inset-0 transition-transform duration-1000">
                        <div id="moon-object" class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl md:text-6xl">ğŸŒ“</div>
                    </div>
                    <div class="absolute -right-20 md:-right-32 top-1/2 -translate-y-1/2 text-7xl md:text-8xl">â˜€ï¸</div>
                </div>
                <div class="text-center">
                    <h3 class="text-3xl font-bold text-yellow-300 mb-4">Ã‡farÃ« shohim nga Toka:</h3>
                    <div id="moon-phase-display" class="text-9xl mb-4">ğŸŒ“</div>
                    <p id="moon-phase-name" class="text-2xl text-gray-300 font-bold mb-6">Ã‡ereku i ParÃ«</p>
                    <button id="phase-btn" class="fun-button">Faza TjetÃ«r</button>
                </div>
            </div>
        </section>

        <section id="apollo" class="section">
            <h2 class="fun-title mb-4">NjÃ« Hap Gjigant!</h2>
            <p class="max-w-3xl text-xl md:text-2xl text-gray-300 mb-8">A e dije qÃ« njerÃ«zit kanÃ« ECUR nÃ« HÃ«nÃ«? Misioni Apollo 11 ishte hera e parÃ« qÃ« njerÃ«zit vizituan njÃ« botÃ« tjetÃ«r.</p>
            
            <div id="video-player-container" class="video-container">
                <div id="apollo-video-player"></div>
            </div>
            
            <p class="max-w-3xl text-xl md:text-2xl text-gray-300 mt-8 mb-8">Kliko shenjÃ«n nÃ« hartÃ«n e HÃ«nÃ«s mÃ« poshtÃ« pÃ«r tÃ« parÃ« ku u ulÃ«n!</p>

            <div class="w-full max-w-lg text-center">
                <div id="moon-map-container" class="aspect-square rounded-full bg-gray-700 relative cursor-pointer mx-auto">
                     <img id="moon-map-image" src="https://images.pexels.com/photos/47367/full-moon-moon-bright-sky-47367.jpeg"
                          class="w-full h-full rounded-full object-cover"
                          onerror="this.onerror=null; this.src='https://placehold.co/800x800/cccccc/ffffff?text=Harta+Alternative';"
                          alt="Harta e HÃ«nÃ«s qÃ« tregon zonÃ«n e uljes sÃ« Apollo 11"/>
                     <img id="sea-of-tranquility-detail" src="https://media.invisioncic.com/g327141/monthly_2018_06/347888625_SabineandRittertheAragoDomesandtheApollo11landingsite.png.be53dcfecf5462798ad2c7b13457e0f9.png"
                          class="w-full h-full rounded-full object-cover"
                          onerror="this.onerror=null; this.src='https://placehold.co/800x800/777777/ffffff?text=Detaj+Alternative';"
                          alt="Pamje e zmadhuar e Detit tÃ« QetÃ«sisÃ«"/>
                    <div id="tranquility-marker-container" class="absolute top-[40%] left-[55%] transform -translate-x-1/2 -translate-y-1/2 cursor-pointer" onclick="zoomToTranquility()">
                        <div class="pulse-marker w-10 h-10 rounded-full border-4 border-yellow-300 bg-yellow-300/50 flex items-center justify-center">
                            <div class="w-2 h-2 rounded-full bg-yellow-100"></div>
                        </div>
                    </div>
                </div>
                <p id="moon-map-caption" class="image-caption">Harta e HÃ«nÃ«s</p>
            </div>
        </section>

        <section id="landing-site" class="section bg-gray-800">
             <h2 class="fun-title mb-4">Deti i QetÃ«sisÃ«</h2>
             <p class="max-w-2xl text-xl md:text-2xl text-gray-300 mb-8">KÃ«tu u ulÃ«n ata! MblodhÃ«n gurÃ« hÃ«ne, bÃ«nÃ« eksperimente dhe lanÃ« gjurmÃ«t e para tÃ« kÃ«mbÃ«ve nÃ« HÃ«nÃ«.</p>
             <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8">
                 <div class="bg-gray-700 p-4 rounded-2xl">
                    <img src="https://scx1.b-cdn.net/csz/news/800a/2020/apollomoon.jpg" class="w-full h-auto rounded-lg object-cover aspect-[3/2]" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Imazhi+i+Misionit+Apollo';" alt="Misioni Apollo 11 nÃ« HÃ«nÃ«">
                    <p class="mt-4 font-bold text-xl">NjÃ« hap i vogÃ«l pÃ«r njeriun...</p>
                 </div>
                 <div class="bg-gray-700 p-4 rounded-2xl">
                    <img src="https://nssdc.gsfc.nasa.gov/imgcat/higher_res/apollo/as11_40_5878.jpg" class="w-full h-auto rounded-lg object-cover aspect-[3/2]" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Imazhi+i+GjurmÃ«s';" alt="GjurmÃ« kÃ«mbe nÃ« HÃ«nÃ«">
                     <p class="mt-4 font-bold text-xl">...njÃ« hap gjigant pÃ«r njerÃ«zimin!</p>
                 </div>
             </div>
        </section>
        
        <section id="noar-adventures" class="section bg-gray-900">
            <h2 class="fun-title mb-8">Aventurat e Noarit nÃ« HapÃ«sirÃ«!</h2>
            <p class="max-w-2xl text-xl md:text-2xl text-gray-300 mb-8">Shikoni disa nga fotot e mrekullueshme tÃ« Noarit duke eksploruar me teleskopin e tij dhe fotot qÃ« ka bÃ«rÃ«!</p>
            <div class="carousel-container">
                <div class="carousel-track">
                    </div>
                <button class="carousel-button prev" onclick="manualCarouselChange(-1)">â®</button>
                <button class="carousel-button next" onclick="manualCarouselChange(1)">â¯</button>
            </div>
        </section>

        <footer class="text-center p-8 bg-gray-900 border-t-0"> 
            <h2 class="fun-title text-4xl mb-4">Faleminderit qÃ« Eksploruat! ğŸš€</h2>
        </footer>
    </main>
    
    <script async src="https://www.youtube.com/iframe_api"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetElement = document.querySelector(this.getAttribute('href'));
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });

            const telescopeCanvasBtn = document.getElementById('telescope-canvas-btn');
            if (telescopeCanvasBtn) {
                telescopeCanvasBtn.addEventListener('click', startCanvasTelescopeAnimation);
            }
            initializeCanvasTelescope();


            const phaseBtn = document.getElementById('phase-btn');
            if (phaseBtn) {
                phaseBtn.addEventListener('click', handleNextMoonPhase);
            }
            
            updateMoonPhaseDisplay(); 
            initializeCarousel();
        });
        
        const lightFacts = {
            sun: "Dielli Ã«shtÃ« njÃ« yll gjigant! Drita e tij merr 8 minuta pÃ«r tÃ« arritur tek ne.",
            lamp: "Llampat pÃ«rdorin energji elektrike pÃ«r tÃ« bÃ«rÃ« dritÃ« qÃ« tÃ« mund tÃ« lexojmÃ« natÃ«n.",
            firefly: "XixÃ«llonjat bÃ«jnÃ« dritÃ«n e tyre. Quhet biolumineshencÃ«!",
            flashlight: "ElektrikÃ«t e dorÃ«s pÃ«rdorin bateri pÃ«r tÃ« bÃ«rÃ« njÃ« rreze drite qÃ« mund ta drejtojmÃ«."
        };
        
        function toggleLightSource(element, source) {
            document.querySelectorAll('.light-source-card').forEach(card => card.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            const factEl = document.getElementById('light-fact');
            if (factEl) {
                factEl.textContent = lightFacts[source] || "";
            }
        }

        // Canvas Telescope Animation
        let canvas, ctx, focalLabelElement;
        let canvasAnimationProgress = 0;
        let canvasAnimFrameId;
        
        // Define coordinates as percentages of canvas width/height for responsiveness
        const canvasStar = { xPercent: 0.1, yPercent: 0.5, radiusPercent: 0.03 }; // Star radius relative to canvas height
        const objectiveLens = { xPercent: 0.35, yPercent: 0.5, widthPercent: 0.03, heightPercent: 0.6 };
        const focalPoint = { xPercent: 0.6, yPercent: 0.5 };
        const eyepieceLens = { xPercent: 0.7, yPercent: 0.5, widthPercent: 0.02, heightPercent: 0.4 };
        const magnifiedStar = { xPercent: 0.9, yPercent: 0.5, initialRadiusPercent: 0.03, magnifiedRadiusPercent: 0.09 };

        const rayInitialOffsetYPercent = 0.06; // Offset from star center for parallel rays, relative to canvas height
        const rayDivergeOffsetYPercent = 0.12; // How much diverging rays spread, relative to canvas height

        function initializeCanvasTelescope() {
            canvas = document.getElementById("telescopeCanvas");
            focalLabelElement = document.getElementById("focalLabel");
            if (!canvas || !focalLabelElement) {
                console.error("Canvas or focal label element not found for telescope animation.");
                return;
            }
            ctx = canvas.getContext("2d");
            
            const container = document.getElementById('telescope-canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            // Position focal label (will be made visible during animation)
            focalLabelElement.style.left = `${focalPoint.xPercent * canvas.width - 25}px`; // Adjust offset as needed
            focalLabelElement.style.top = `${focalPoint.yPercent * canvas.height + 10}px`; // Adjust offset as needed

            drawStaticCanvasElements(); // Draw initial state
        }

        function drawStaticCanvasElements() {
            if (!ctx || !canvas) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Star
            ctx.fillStyle = "#FFD700"; // Gold for star
            ctx.beginPath();
            ctx.arc(canvasStar.xPercent * canvas.width, canvasStar.yPercent * canvas.height, canvasStar.radiusPercent * canvas.height, 0, Math.PI * 2);
            ctx.fill();

            // Lenses
            ctx.fillStyle = "rgba(100, 150, 255, 0.5)"; // Light blue, semi-transparent
            ctx.beginPath(); // Objective Lens
            ctx.ellipse(objectiveLens.xPercent * canvas.width, objectiveLens.yPercent * canvas.height, 
                        objectiveLens.widthPercent * canvas.width, objectiveLens.heightPercent * canvas.height / 2, 
                        0, 0, Math.PI * 2);
            ctx.fill();

            ctx.beginPath(); // Eyepiece Lens
            ctx.ellipse(eyepieceLens.xPercent * canvas.width, eyepieceLens.yPercent * canvas.height, 
                        eyepieceLens.widthPercent * canvas.width, eyepieceLens.heightPercent * canvas.height / 2, 
                        0, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawAnimatedCanvasElements(progress) {
            if (!ctx || !canvas) return;
            drawStaticCanvasElements(); // Redraw static parts
            
            ctx.strokeStyle = "#f6e05e"; // Light ray color
            ctx.lineWidth = 2;

            const starX = canvasStar.xPercent * canvas.width;
            const starY = canvasStar.yPercent * canvas.height;
            const objLensX = objectiveLens.xPercent * canvas.width;
            const focalX = focalPoint.xPercent * canvas.width;
            const focalY = focalPoint.yPercent * canvas.height;
            const eyepieceX = eyepieceLens.xPercent * canvas.width;
            const magnifiedStarX = magnifiedStar.xPercent * canvas.width;

            const rayY1Initial = starY - rayInitialOffsetYPercent * canvas.height;
            const rayY2Initial = starY + rayInitialOffsetYPercent * canvas.height;

            // Phase 1: Parallel rays to objective lens
            const phase1EndTime = objLensX - starX;
            let currentLenPhase1 = Math.min(progress, phase1EndTime);
            
            ctx.beginPath();
            ctx.moveTo(starX, rayY1Initial);
            ctx.lineTo(starX + currentLenPhase1, rayY1Initial);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(starX, rayY2Initial);
            ctx.lineTo(starX + currentLenPhase1, rayY2Initial);
            ctx.stroke();

            // Phase 2: Converging rays from objective lens to focal point
            if (progress > phase1EndTime) {
                focalLabelElement.style.opacity = '0'; // Hide initially
                const phase2Progress = progress - phase1EndTime;
                const phase2MaxLen = focalX - objLensX;
                const currentLenPhase2 = Math.min(phase2Progress, phase2MaxLen);
                const factor = Math.min(phase2Progress / phase2MaxLen, 1);

                ctx.beginPath();
                ctx.moveTo(objLensX, rayY1Initial);
                ctx.lineTo(objLensX + currentLenPhase2 * Math.cos(Math.atan2(focalY - rayY1Initial, focalX - objLensX)), 
                           rayY1Initial + currentLenPhase2 * Math.sin(Math.atan2(focalY - rayY1Initial, focalX - objLensX)));
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(objLensX, rayY2Initial);
                ctx.lineTo(objLensX + currentLenPhase2 * Math.cos(Math.atan2(focalY - rayY2Initial, focalX - objLensX)), 
                           rayY2Initial + currentLenPhase2 * Math.sin(Math.atan2(focalY - rayY2Initial, focalX - objLensX)));
                ctx.stroke();
                
                if (factor >= 0.95) { // Show focal point label when rays almost meet
                   focalLabelElement.style.opacity = '1';
                }
            }

            // Phase 3: Diverging rays from focal point through eyepiece
            const phase2EndTime = phase1EndTime + (focalX - objLensX);
            if (progress > phase2EndTime) {
                const phase3Progress = progress - phase2EndTime;
                const phase3MaxLen = magnifiedStarX - focalX; // Rays extend to magnified star position
                const currentLenPhase3 = Math.min(phase3Progress, phase3MaxLen);

                const outY1 = focalY - rayDivergeOffsetYPercent * canvas.height * (currentLenPhase3 / phase3MaxLen); // Spread increases with progress
                const outY2 = focalY + rayDivergeOffsetYPercent * canvas.height * (currentLenPhase3 / phase3MaxLen);

                ctx.beginPath();
                ctx.moveTo(focalX, focalY);
                ctx.lineTo(focalX + currentLenPhase3 * Math.cos(Math.atan2(outY1 - focalY, magnifiedStarX - focalX)), 
                           focalY + currentLenPhase3 * Math.sin(Math.atan2(outY1 - focalY, magnifiedStarX - focalX)));
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(focalX, focalY);
                ctx.lineTo(focalX + currentLenPhase3 * Math.cos(Math.atan2(outY2 - focalY, magnifiedStarX - focalX)), 
                           focalY + currentLenPhase3 * Math.sin(Math.atan2(outY2 - focalY, magnifiedStarX - focalX)));
                ctx.stroke();

                // Draw magnified star
                const magnifiedProgress = Math.min(phase3Progress / (magnifiedStarX - eyepieceX), 1); // Progress for star appearance
                if (magnifiedProgress > 0.1) { // Start showing a bit after rays pass eyepiece
                    const currentRadius = magnifiedStar.initialRadiusPercent * canvas.height + 
                                       (magnifiedStar.magnifiedRadiusPercent - magnifiedStar.initialRadiusPercent) * canvas.height * Math.min(magnifiedProgress / 0.9, 1) ; // Scale up
                    ctx.fillStyle = "#FFD700";
                    ctx.beginPath();
                    ctx.arc(magnifiedStarX, magnifiedStar.yPercent * canvas.height, currentRadius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
        
        function startCanvasTelescopeAnimationLoop() {
            if (!ctx || !canvas) return;
            drawAnimatedCanvasElements(canvasAnimationProgress);
            
            const totalAnimationDistance = magnifiedStar.xPercent * canvas.width; // Full width of animation
            if (canvasAnimationProgress < totalAnimationDistance) {
                canvasAnimationProgress += 4; // Animation speed
                canvasAnimFrameId = requestAnimationFrame(startCanvasTelescopeAnimationLoop);
            } else {
                focalLabelElement.style.opacity = '0'; // Hide focal label at the end
            }
        }

        function startCanvasTelescopeAnimation() {
            if (canvasAnimFrameId) {
                cancelAnimationFrame(canvasAnimFrameId);
            }
            canvasAnimationProgress = 0;
            focalLabelElement.style.opacity = '0';
            startCanvasTelescopeAnimationLoop();
        }


        let moonPhaseIndex = 0; 
        const moonPhasesData = [
            { emoji: 'ğŸŒ“', name: 'Ã‡ereku i ParÃ«', angle: 0 },      
            { emoji: 'ğŸŒ”', name: 'Gunga RritÃ«se', angle: 45 },
            { emoji: 'ğŸŒ•', name: 'HÃ«na e PlotÃ«', angle: 90 },
            { emoji: 'ğŸŒ–', name: 'Gunga ZbritÃ«se', angle: 135 },
            { emoji: 'ğŸŒ—', name: 'Ã‡ereku i Fundit', angle: 180 }, 
            { emoji: 'ğŸŒ˜', name: 'Draperi ZbritÃ«s', angle: 225 },
            { emoji: 'ğŸŒ‘', name: 'HÃ«na e Re', angle: 270 },
            { emoji: 'ğŸŒ’', name: 'Draperi RritÃ«s', angle: 315 }
        ];
        
        let currentVisualOrbitAngle = moonPhasesData[moonPhaseIndex].angle;

        function updateMoonPhaseDisplay() {
            const phase = moonPhasesData[moonPhaseIndex];
            const moonPhaseDisplayEl = document.getElementById('moon-phase-display');
            const moonPhaseNameEl = document.getElementById('moon-phase-name');
            const moonObjectEl = document.getElementById('moon-object');

            if (moonPhaseDisplayEl) moonPhaseDisplayEl.textContent = phase.emoji;
            if (moonPhaseNameEl) moonPhaseNameEl.textContent = phase.name;
            if (moonObjectEl) moonObjectEl.textContent = phase.emoji; 
            
            const moonOrbitEl = document.getElementById('moon-orbit');
            if (moonOrbitEl) moonOrbitEl.style.transform = `rotate(${currentVisualOrbitAngle}deg)`;
        }

        function handleNextMoonPhase() {
            const previousCanonicalAngle = moonPhasesData[moonPhaseIndex].angle;
            moonPhaseIndex = (moonPhaseIndex + 1) % moonPhasesData.length;
            const nextCanonicalAngle = moonPhasesData[moonPhaseIndex].angle;

            let angleDifference;
            if (nextCanonicalAngle < previousCanonicalAngle) { 
                angleDifference = (360 - previousCanonicalAngle) + nextCanonicalAngle;
            } else {
                angleDifference = nextCanonicalAngle - previousCanonicalAngle;
            }
            currentVisualOrbitAngle += angleDifference;

            updateMoonPhaseDisplay();
        }

        function zoomToTranquility() {
            const moonMapImage = document.getElementById('moon-map-image');
            const detailImage = document.getElementById('sea-of-tranquility-detail');
            const markerContainer = document.getElementById('tranquility-marker-container');
            const landingSiteSection = document.getElementById('landing-site');
            const captionElement = document.getElementById('moon-map-caption');

            if (moonMapImage && detailImage && markerContainer && landingSiteSection && captionElement) {
                const originX = '55%'; 
                const originY = '40%';
                moonMapImage.style.transformOrigin = `${originX} ${originY}`;
                detailImage.style.transformOrigin = `${originX} ${originY}`;
                
                moonMapImage.classList.add('zoomed-in');
                markerContainer.style.opacity = '0';
                if(captionElement) captionElement.textContent = 'Deti i QetÃ«sisÃ« (Pamje e Zmadhuar)';


                setTimeout(() => {
                    moonMapImage.style.opacity = '0';
                    detailImage.classList.add('visible-zoomed');
                }, 300); 

                setTimeout(() => {
                    landingSiteSection.scrollIntoView({ behavior: 'smooth' });
                }, 2500); 

                setTimeout(() => {
                    moonMapImage.classList.remove('zoomed-in');
                    moonMapImage.style.opacity = '1';
                    detailImage.classList.remove('visible-zoomed');
                    markerContainer.style.opacity = '1';
                    if(captionElement) captionElement.textContent = 'Harta e HÃ«nÃ«s';
                }, 4000); 
            }
        }

        const carouselTrack = document.querySelector('.carousel-track');
        const carouselContainer = document.querySelector('.carousel-container');
        const placeholderImageSources = [
            "images/noari_telescope1.webp",
            "images/noari_telescope2.webp",
            "images/noari_hena.webp",
            "images/noari_telescope3.webp",
            "images/noari_space.webp" 
        ];
        const slideWidth = 500; 
        const slideMargin = 16; 
        const totalSlideWidth = slideWidth + slideMargin;
        let currentTrackPosition = 0;
        let scrollSpeed = 0.8; 
        let isCarouselPaused = false;
        let carouselAnimFrameId;

        function populateCarousel() {
            if (!carouselTrack) return;
            carouselTrack.innerHTML = ''; 
            const allImages = [...placeholderImageSources, ...placeholderImageSources]; 
            allImages.forEach(src => {
                const slideDiv = document.createElement('div');
                slideDiv.classList.add('carousel-slide');
                const img = document.createElement('img');
                img.src = src;
                img.alt = "Imazh nga aventurat e Noarit"; 
                img.onerror = function() { this.onerror=null; this.src='https://placehold.co/800x500/777777/ffffff?text=Problem+me+Imazhin+(webp)'; };
                slideDiv.appendChild(img);
                carouselTrack.appendChild(slideDiv);
            });
            carouselTrack.style.width = `${totalSlideWidth * allImages.length}px`;
        }

        function autoScrollCarousel() {
            if (!isCarouselPaused && carouselTrack) {
                currentTrackPosition -= scrollSpeed;
                if (currentTrackPosition <= -(totalSlideWidth * placeholderImageSources.length)) {
                    carouselTrack.style.transition = 'none'; 
                    currentTrackPosition += (totalSlideWidth * placeholderImageSources.length);
                    carouselTrack.style.transform = `translateX(${currentTrackPosition}px)`;
                    void carouselTrack.offsetWidth; 
                    carouselTrack.style.transition = ''; 
                } else {
                    carouselTrack.style.transform = `translateX(${currentTrackPosition}px)`;
                }
            }
            carouselAnimFrameId = requestAnimationFrame(autoScrollCarousel);
        }
        
        function manualCarouselChange(direction) {
            if (!carouselTrack) return;
            isCarouselPaused = true; 
            cancelAnimationFrame(carouselAnimFrameId);

            const numOriginalSlides = placeholderImageSources.length;
            let currentEffectiveIndex = Math.floor(Math.abs(currentTrackPosition) / totalSlideWidth);
            
            currentEffectiveIndex += direction;
            currentTrackPosition = -(currentEffectiveIndex * totalSlideWidth);

            const totalOriginalSetWidth = totalSlideWidth * numOriginalSlides;
            if (currentTrackPosition < -totalOriginalSetWidth) { 
                currentTrackPosition += totalOriginalSetWidth; 
            } else if (currentTrackPosition > 0) { 
                currentTrackPosition -= totalOriginalSetWidth; 
                if (currentTrackPosition === 0 && direction === -1) currentTrackPosition = -totalOriginalSetWidth + totalSlideWidth;
            }
            
            carouselTrack.style.transition = 'transform 0.5s ease-in-out'; 
            carouselTrack.style.transform = `translateX(${currentTrackPosition}px)`;
            
            setTimeout(() => {
                if (carouselTrack) carouselTrack.style.transition = 'none'; 
                if (carouselContainer && !carouselContainer.matches(':hover')) { 
                    isCarouselPaused = false;
                    autoScrollCarousel();
                }
            }, 500); 
        }

        function initializeCarousel() {
            populateCarousel();
            if (carouselContainer && carouselTrack) {
                carouselContainer.addEventListener('mouseenter', () => {
                    isCarouselPaused = true;
                    if (carouselAnimFrameId) cancelAnimationFrame(carouselAnimFrameId);
                });
                carouselContainer.addEventListener('mouseleave', () => {
                    isCarouselPaused = false;
                    if (carouselTrack) carouselTrack.style.transition = 'none'; 
                    autoScrollCarousel(); 
                });
                if (carouselTrack) carouselTrack.style.transition = 'none'; 
                autoScrollCarousel(); 
            }
        }

        // YouTube Player API
        let apolloVideoPlayer;
        const videoId = 'g5aPoRtF2vw'; 

        function onYouTubeIframeAPIReady() {
            apolloVideoPlayer = new YT.Player('apollo-video-player', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'playsinline': 1,
                    'modestbranding': 1,
                    'rel': 0,
                    'controls': 0 
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange 
                }
            });
        }

        function onPlayerReady(event) {
            setupVideoObserver();
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
                const moonMapElement = document.getElementById('moon-map-container'); 
                if (moonMapElement) {
                    moonMapElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                }
            }
        }

        function setupVideoObserver() {
            const videoContainer = document.getElementById('video-player-container');
            if (!videoContainer || !apolloVideoPlayer) return;

            const observerOptions = {
                root: null, 
                rootMargin: '0px',
                threshold: 0.5 
            };

            const observerCallback = (entries, observer) => {
                entries.forEach(entry => {
                    if (typeof apolloVideoPlayer.playVideo !== 'function' || typeof apolloVideoPlayer.pauseVideo !== 'function') {
                        return;
                    }
                    if (entry.isIntersecting) {
                        apolloVideoPlayer.playVideo();
                    } else {
                        if (apolloVideoPlayer.getPlayerState && apolloVideoPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                            apolloVideoPlayer.pauseVideo();
                        }
                    }
                });
            };

            const videoObserver = new IntersectionObserver(observerCallback, observerOptions);
            videoObserver.observe(videoContainer);
        }

    </script>
</body>
</html>

